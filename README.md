# Проект Viva Logistics

![](https://img.shields.io/badge/%D1%81%D1%82%D0%B0%D1%82%D1%83%D1%81-%D0%B2%20%D1%80%D0%B0%D0%B7%D1%80%D0%B0%D0%B1%D0%BE%D1%82%D0%BA%D0%B5-yellow.svg?style=flat)
![](https://img.shields.io/badge/%D0%BF%D1%80%D0%B8%D0%B1%D0%BB%D0%B8%D0%B7%D0%B8%D1%82%D0%B5%D0%BB%D1%8C%D0%BD%D0%B0%D1%8F%20%D0%B3%D0%BE%D1%82%D0%BE%D0%B2%D0%BD%D0%BE%D1%81%D1%82%D1%8C-95%25-yellow.svg?style=flat)

Viva Logistics - сервис по доставке товаров из Китая. Проект реализован на языке PHP с использованием Yii2 Framework.

## Развертывание и установка

> **ВНИМАНИЕ!** Для корректной работы вам потребуется веб-сервер (Apache/Nginx) с поддержкой PHP (рекомендуемая версия - не ниже 7.0), а также MySQL. Также вам понадобится менеджер пакетов PHP - composer.

### Конфигурация БД

Файл конфигурации БД - `config/db.php`
 - Название базы: viva
 - Пользователь: root
 - Пароль: root

### Обновление из composer

Вам потребуется менеджер пакетов и зависимостей - composer. Убедитесь что он присутствует в вашей системе. Инструкцию по установке composer можно найти [здесь](https://getcomposer.org/doc/00-intro.md).

Чтобы загрузить все необходимые библиотеки и зависимости, перейдите в папку проекта через терминал, и выполните команду:

> composer update

Дождитесь окончания выполнения команды.

### Миграции

Следующим этапом является запуск миграций. Это подготовит БД к использованию и создаст необходимые таблицы. Находясь в папке проект запустите следующую команду:

> php yii migrate

### База локаций СДЕК

В сервисе присутствует взаимодействие со СДЕК (калькулятор стоимости и т.д.). В целях оптимизации из СДЕК API загружаются некоторые данные для последующего локального хранения и многократного использования (список регионов и городов).

Для корректной работы вам необходимо загрузить данные о регионах и городах СДЕК. Для этого запустите следующую команду:

> php yii cdek/refresh-locations

При выполнении данной команды происходит обращение к API СДЕК. У вас могут возникнуть проблемы если данные для подключения к СДЕК API не корректны. Данные для подключения к аккаунту СДЕК находятся в базе. Их можно изменить в разделе настроек (об этом далее)

## Управление

После того как проект будет уже развернут, у вас появится возможность авторизоваться как администратор.

 - Логин администратора: admin
 - Пароль администратора: 123456

После авторизации вы попадете в личный кабинет администратора. В разделе настроек вы сможете настроить подключения для рассылки SMTP, а также для API СДЕК.

Если у вас появились проблемы на этапе развертывания "База локаций СДЕК" по причине ошибки подключения к СДЕК, вы можете попробовать изменить настройки, и повторить выполнение команды.

## Автоматическое отслеживание состояний заказов

### Kuadi100

Для автоматического отслеживания состояний заказов, которые находятся только в пути на склад, система должна периодически проверять статусы вложений заказа по указанным трек-номерам.

Чтобы это было возможным, внесите в планировщик задач на вашем сервере/хостинге следующую команду:

> php yii kuaidi100/update-order-statuses

### СДЕК

Для автоматического отслеживания состояний заказов, которые были высланы клиентам через систему СДЕК, вы можете использовать 2 способа:

 - Опрос состояний со стороны системы
 - Веб-хуки (СДЕК сам будет уведомлять о смене состояния зарегистрированного заказа)

Наиболее предпочтителен второй способ. Его вы можете включить в настройках API. Также рекомендуется нажать на кнопку обновления веб-хуков _(это возможно только если все ключи API СДЕК введены)_

Если по каким-либо причинам вы хотите использовать первый вариант (опрос API), необходимо прописать в планировщике следующую команду:

> php yii cdek/update-order-statuses

## API

У Viva есть API для отслеживания посылок (получения списка изменений статусов посылки) и взаимодействия с калькулятором стоимости.

Шаблонный URL для обращения к API следующий:
> http(s)://ваш-домен/api/название-метода-api?параметр1=значение1&параметр2=значение2`

Параметры передаются как обычный GET запрос, ответ приходит в виде JSON. Поле `status` у ответа показывает, есть ли ошибка в обработке запроса. Если ошибки нет, поле `status` принимает значение `ok`.

В API есть следующие методы:

### Отслеживание
  
> http(s)://ваш-домен/api/track 

Параметры:
- `unique_number` (string) - Уникальный номер заказа из личного кабинета
  
Примеры ответа:
```json
{
  "status":"ok",
  "data":[
    {"time":"2021-11-21 16:52:25","status":{"name":"В пути на склад","code":1}},
    {"time":"2021-11-21 16:53:52","status":{"name":"Собирается","code":2}},
    {"time":"2021-11-21 16:54:25","status":{"name":"Проблемы","code":3}},
    {"time":"2021-11-21 18:12:20","status":{"name":"Собирается","code":2}},
    {"time":"2021-11-21 18:18:55","status":{"name":"Ждет оплаты","code":5}}
  ]
}
```

```json
{
  "status":"error",
  "info":"Order not found"
}
```

### Калькулятор

> http(s)://ваш-домен/api/calculator 

Параметры (обязательные отмечены звездочкой):
- `insurance_price`* (float) - Цена страховки
- `weight_kg`* (float) - Вес посылки (в килограммах)
- `size_length_cm`* (float) - Длина в (в сантиметрах)
- `size_height_cm`* (float) - Высота в (в сантиметрах)
- `size_width_cm`* (float) - Ширина в (в сантиметрах)
- `shipping_type_id`* (int) - Тип доставки
- `pack_type_id`* (int) - Тип упаковки
- `addr_shipping_russia_id`* (int) - Тип доставки по России
- `addr_cdek_city_code` (int) - Идентификатор города доставки СДЭК (если доставка по России через СДЭК)
- `addr_cdek_tariff_id` (float) - Идентификатор тарифа СДЭК (если доставка по России через СДЭК)

Примеры ответа:
```json
{
  "status":"ok",
  "data":5540
}
```
```json
{
  "status":"error",
  "info":"Wrong packing type ID"
}
```

Детали параметров:

- Тип доставки по России (`addr_shipping_russia_id`) принимает значения: 1 (Москва, экспресс доставка), 2 (Вся Россия, через СДЭК). При значении 2 параметры `addr_cdek_city_code` и `addr_cdek_tariff_id` должны быть указаны.
- Тип доставки (`shipping_type_id`) - см. метод API для получения типов доставки
- Тип упаковки (`pack_type_id`) - см. метод API для получения типов упаковки
- Идентификатор города доставки СДЭК (`addr_cdek_city_code`) см. методы API для получения городов и регионов СДЭК
- Идентификатор тарифа СДЭК (если доставка по России через СДЭК) (`addr_cdek_tariff_id`) см. метод API для получения тарифов СДЭК


### Получение тарифов СДЭК

> http(s)://ваш-домен/api/cdek-tariffs

### Получение типов упаковки

> http(s)://ваш-домен/api/pack-types

### Получение типов доставки

> http(s)://ваш-домен/api/shipping-types

### Получение регионов СДЭК

> http(s)://ваш-домен/api/cdek-regions

### Получение городов СДЭК

> http(s)://ваш-домен/api/cdek-cities

Параметры:
- `region_id` (int) - Идентификатор региона СДЭК

## Переводы текстов сообщений отслеживания (от Kuaidi100)

При отслеживании посылок в Китае, API для взаимодействия с сервисом отслеживания возвращает информацию на китайском языке.
Текст может быть автоматически переведен на русский при помощи машинного перевода (Яндекс). Для этого необходимо указать в настройках следующие данные:

- Yandex OAuth token (для авто-переводов ответов китайского API)
- Идентификатор каталога Yandex.Cloud

Если эти данные указаны, то для текстов, которые отдает китайское API будут включен машинный перевод. Для получения этих данных вам нужен аккаунт Яндекс.Облака, настроенный должным образом (для возможности пользоваться сервисом переводов)

Инструкцию по настройке аккаунта и получению всех необходимых токенов и идентификаторов можно найти по этим ссылкам:

- [Настройка аккаунта Яндекс.Облака для переводов](https://cloud.yandex.ru/docs/_includes/translate/translate-instruction)
- [Получение IAM токена Яндекс.Облака](https://cloud.yandex.ru/docs/iam/operations/iam-token/create)
- [Получение идентификатора каталога для Яндекс.Облака](https://cloud.yandex.ru/docs/resource-manager/operations/folder/get-id)
- [Биллинг-аккаунты Яндекс.Облака](https://console.cloud.yandex.ru/billing?section=accounts)

При настройке аккаунта Яндекс.Облака убедитесь что все делаете верно:
![Instructions](README_img_01.png)